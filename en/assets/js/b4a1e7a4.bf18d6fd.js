"use strict";(self.webpackChunkklipper_docs=self.webpackChunkklipper_docs||[]).push([["38887"],{51188:function(e,n,i){i.r(n),i.d(n,{metadata:()=>t,contentTitle:()=>a,default:()=>c,assets:()=>l,toc:()=>d,frontMatter:()=>r});var t=JSON.parse('{"id":"ProductDoc/ExtensionBoard/BDsensor-m/marlin","title":"Install **BDsensor-m-m**","description":"Connect the sensor cable to the EXP1 interface on the mainboard","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/ProductDoc/ExtensionBoard/BDsensor-m/marlin.mdx","sourceDirName":"ProductDoc/ExtensionBoard/BDsensor-m","slug":"/ProductDoc/ExtensionBoard/BDsensor-m/marlin","permalink":"/fly-docs-next/en/docs/ProductDoc/ExtensionBoard/BDsensor-m/marlin","draft":false,"unlisted":false,"editUrl":"https://github.com/kluoyun/fly-docs-next/tree/master/docs/ProductDoc/ExtensionBoard/BDsensor-m/marlin.mdx","tags":[],"version":"current","lastUpdatedBy":"xishangxi","lastUpdatedAt":1735539080000,"sidebarPosition":3,"frontMatter":{"sidebar_position":3,"sidebar_label":"Using Marlin"},"sidebar":"tutorialSidebar","previous":{"title":"Using klipper","permalink":"/fly-docs-next/en/docs/ProductDoc/ExtensionBoard/BDsensor-m/kliper"},"next":{"title":"BDsensor","permalink":"/fly-docs-next/en/docs/category/bdsensor"}}'),s=i("52676"),o=i("79938");let r={sidebar_position:3,sidebar_label:"Using Marlin"},a="Install BDsensor-m-m",l={},d=[{value:"Connect the sensor cable to the EXP1 interface on the mainboard",id:"connect-the-sensor-cable-to-the-exp1-interface-on-the-mainboard",level:2},{value:"Install the patch into the Marlin firmware",id:"install-the-patch-into-the-marlin-firmware",level:2},{value:"Edit configuration.h",id:"edit-configurationh",level:3},{value:"Edit Configuration_adv.h",id:"edit-configuration_advh",level:3},{value:"Edit pins_boardname.h",id:"edit-pins_boardnameh",level:3},{value:"Display BDsensor value on the LCD screen",id:"display-bdsensor-value-on-the-lcd-screen",level:2},{value:"Calibration",id:"calibration",level:2},{value:"Testing and Printing",id:"testing-and-printing",level:2},{value:"There are two ways to automatically level the bed:",id:"there-are-two-ways-to-automatically-level-the-bed",level:2},{value:"Check Z Endstop <code>M119</code>",id:"check-z-endstop-m119",level:3},{value:"Check Connection",id:"check-connection",level:3},{value:"If all the steps above are correct, you can now home the Z-axis.",id:"if-all-the-steps-above-are-correct-you-can-now-home-the-z-axis",level:2}];function h(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components},{ImageView:t}=n;return!t&&function(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("ImageView",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsxs)(n.h1,{id:"install-bdsensor-m-m",children:["Install ",(0,s.jsx)(n.strong,{children:"BDsensor-m-m"})]})}),"\n",(0,s.jsx)(n.h2,{id:"connect-the-sensor-cable-to-the-exp1-interface-on-the-mainboard",children:"Connect the sensor cable to the EXP1 interface on the mainboard"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"If the sensor cable is not long enough, you can use the extension cable provided in the package."}),"\n",(0,s.jsx)(n.li,{children:"The CKL and SDA lines of the BDsensor-m-m can be connected to any GPIO pin on the circuit board. You can also directly connect the BDsensor cable to the Bltouch port, for example:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"BLtouch    |    BDsensor-m\n5V       --\x3e     5V\nGND      --\x3e     GND\nS        --\x3e     CLK/SCL    (Input)\nGND      --\x3e     GND\nZmin     --\x3e     SDA    (Input/Output) \n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Some pins in the mainboard connector may not be directly connected to the MCU's GPIOs (e.g., they might have filtering capacitors or be isolated through MOSFETs, diodes, or optocouplers, but if they are isolated through resistors or pull-up/pull-down resistors, they can also be used), so they cannot be used with the BDsensor-m. The firmware will report a connection error. For example:"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Fan and heater connectors are isolated through MOSFETs,"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Connectors for temperature thermistors and endstops/probes in some boards are typically connected to GND through filtering capacitors,"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Install the BDsensor close to the hotend as shown in the figure below. ",(0,s.jsx)(n.a,{href:"https://www.thingiverse.com/thing:6098131",children:"STL of mount"}),",  ",(0,s.jsx)(n.a,{href:"https://discord.com/channels/829828765512106054/1163237892957671424",children:"STL_mount_VzBot_Goliath short"})]}),"\n",(0,s.jsx)(t,{image:i(82273).Z,size:"100%",align:"left"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"install-the-patch-into-the-marlin-firmware",children:"Install the patch into the Marlin firmware"}),"\n",(0,s.jsx)(n.p,{children:"The BD sensor has been integrated into Marlin2.1.x (since 2022.8.27),"}),"\n",(0,s.jsxs)(n.p,{children:["You can download the release version. However, it is now recommended to download the latest bug fix version: ",(0,s.jsx)(n.a,{href:"https://github.com/MarlinFirmware/Marlin",children:"https://github.com/MarlinFirmware/Marlin"})]}),"\n",(0,s.jsx)(n.p,{children:"You need to change the configuration files and pin files."}),"\n",(0,s.jsx)(n.h3,{id:"edit-configurationh",children:"Edit configuration.h"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Enable BD_SENSOR"}),"\n",(0,s.jsx)(n.p,{children:"Uncomment"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"#define BD_SENSOR`\n#define Z_SAFE_HOMING\n#define BD_SENSOR_PROBE_NO_STOP //adding this new line for fast bed leveling without nozzle stop, \n"})}),"\n",(0,s.jsxs)(n.p,{children:["Only for ",(0,s.jsx)(n.code,{children:"BD_SENSOR_PROBE_NO_STOP"})]}),"\n",(0,s.jsxs)(n.p,{children:["Latest Marlin bug fix: ",(0,s.jsx)(n.a,{href:"https://github.com/MarlinFirmware/Marlin",children:"https://github.com/MarlinFirmware/Marlin"})]}),"\n",(0,s.jsxs)(n.p,{children:["Description: ",(0,s.jsx)(n.a,{href:"https://github.com/MarlinFirmware/Marlin/pull/25847",children:"https://github.com/MarlinFirmware/Marlin/pull/25847"})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Home with probe"}),"\n",(0,s.jsxs)(n.p,{children:["Ensure Z_MIN_PROBE_USES_Z_MIN_ENDSTOP_PIN is disabled, and enable ",(0,s.jsx)(n.code,{children:"USE_PROBE_FOR_Z_HOMING"})," as shown below:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"//#define Z_MIN_PROBE_USES_Z_MIN_ENDSTOP_PIN\n// Force the use of the probe for Z-axis homing\n#define USE_PROBE_FOR_Z_HOMING\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Slow down the second Z homing speed"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"#define Z_PROBE_FEEDRATE_SLOW (Z_PROBE_FEEDRATE_FAST / 16)\n"})}),"\n",(0,s.jsx)(n.p,{children:"Here, we must slow down the bump homing speed and Z homing speed because the endstop read from the BDsensor-m process is not as real-time as a normal endstop."}),"\n",(0,s.jsx)(n.h3,{id:"edit-configuration_advh",children:"Edit Configuration_adv.h"}),"\n",(0,s.jsxs)(n.p,{children:["Enable ",(0,s.jsx)(n.code,{children:"#define BABYSTEPPING"})," for real-time leveling functionality"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"#define HOMING_BUMP_DIVISOR { 2, 2, 8 }       // Re-Bump Speed Divisor (Divides the Homing Feedrate)\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"edit-pins_boardnameh",children:"Edit pins_boardname.h"}),"\n",(0,s.jsxs)(n.p,{children:["Configure the SDA and SCL pins for the BDsensor-m in the pin file pins_boardname.h by adding the following 3 lines (for example): ",(0,s.jsx)(n.code,{children:"pins_PANDA_PI_V29.h"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"#define  I2C_BD_SDA_PIN    PC6   // Please change to the actual number which the SDA wire is connected to your mainboard\n#define  I2C_BD_SCL_PIN    PB2   // Please change to the actual number which the SLK wire is connected to your mainboard\n#define  I2C_BD_DELAY  20      // default value is 20, should be in the range [20,50].\n"})}),"\n",(0,s.jsx)(n.p,{children:"If you want to do an automatic bed leveling probe like a normal BLtouch before printing (G29), uncomment"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"#define AUTO_BED_LEVELING_BILINEAR\n"})}),"\n",(0,s.jsx)(n.p,{children:"and edit the values as follows:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"#define Z_CLEARANCE_DEPLOY_PROBE   0 // Z Clearance for Deploy/Stow\n#define Z_CLEARANCE_BETWEEN_PROBES  1 // Z Clearance between probe points\n#define Z_CLEARANCE_MULTI_PROBE     1 // Z Clearance between multiple probes\n"})}),"\n",(0,s.jsx)(n.h2,{id:"display-bdsensor-value-on-the-lcd-screen",children:"Display BDsensor value on the LCD screen"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"For printers with status display (supporting gcode M117), like LCD12864 or some UART screens, like ender3V2 ..."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"calibration",children:"Calibration"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Clean the nozzle, then move the Z-axis via the console until the nozzle just touches the bed (BDsensor-m will use this position as the 0 point, so no z_offset is needed, we set the value to 0)."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Send the gcode command ",(0,s.jsx)(n.code,{children:"M102 S-6"}),", the printer will slowly move the Z-axis up by 0.1mm each time until it reaches 4mm. Do not run M102 S-6 before installing the sensor, and do not turn off the printer power during calibration, otherwise, the old calibration data will be deleted. If this happens, just recalibrate."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["You can send ",(0,s.jsx)(n.code,{children:"M102 S-5"})," to check if the BDsensor has been successfully calibrated, this will return the raw calibration data stored in the BDsensor."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["There is also a calibration tool that can do this: ",(0,s.jsx)(n.a,{href:"https://github.com/markniu/Bed_Distance_sensor/raw/new/marlin/BD_Config_Tool_Marlin.zip",children:"https://github.com/markniu/Bed_Distance_sensor/raw/new/marlin/BD_Config_Tool_Marlin.zip"})," ",(0,s.jsx)(n.img,{src:"https://raw.githubusercontent.com/markniu/Bed_Distance_sensor/main/doc/images/Read.jpg",alt:"img"})]}),"\n",(0,s.jsx)(n.p,{children:"Note: A data value of 1015 or > 1010 indicates the sensor is out of range. If the first 5 points (0~0.5mm) or more values are in the range of 0 to 1000, and the increasing delta value is >=10, it indicates a successful calibration. As shown in the chart above."}),"\n",(0,s.jsx)(n.p,{children:"If the first raw calibration data returned by M102 S-5 is greater than 400, it means the sensor is installed too high and needs to be reinstalled closer to the bed. Also, ensure the second data value is more than 10 greater than the first."}),"\n",(0,s.jsx)(n.h2,{id:"testing-and-printing",children:"Testing and Printing"}),"\n",(0,s.jsx)(n.p,{children:"Menu bed leveling"}),"\n",(0,s.jsx)(n.p,{children:"Automatic bed leveling"}),"\n",(0,s.jsx)(n.h2,{id:"there-are-two-ways-to-automatically-level-the-bed",children:"There are two ways to automatically level the bed:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"1. Use M102 for real-time leveling of the first few layers"})}),"\n",(0,s.jsx)(n.p,{children:"We can easily enable or disable this auto-level by sending the gcode command or adding it in the gcode file."}),"\n",(0,s.jsxs)(n.p,{children:['To enable bed leveling in Cura, add the M102 G-code right below the G102 (home all axes) G-code in the "Start G-code" section of the printer machine settings. For example, below G28, this means it will only do bed leveling when the Z-axis height is below 0.2mm. ',(0,s.jsx)(n.code,{children:"M102 S2"})]}),"\n",(0,s.jsxs)(n.p,{children:["Sending or adding this will disable bed leveling with the BDsensor, by the way, it's disabled by default. ",(0,s.jsx)(n.code,{children:"M102 S0``G28``M18"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"M102   S-1     //Read sensor information, and we can use this for connection checking.\nM102   S-2     //Read current distance value\nM102   S-5     //Read raw Calibrate data\nM102   S-6     //Start Calibrate, before that make sure the nozzle is just touching the bed, and then the printer is restarted. Do not home the Z axis before this.\nM102   S4      //Set the adjustable Z height value, e.g. M102 S4 means it will do adjusting while the Z height <=0.4mm, disable it by M102 S0.\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"2. G29 Automatic Bed Leveling"})}),"\n",(0,s.jsx)(n.p,{children:"Another way to automatically level the bed is like the BLtouch's G29, just add a line G28 below G29."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://www.pandapi3d.com/post/install-bed-distance-sensor-video",children:"Installation Video"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://youtu.be/VLUfvkO2NFc?si=PF_6nhw39KhHBhcj",children:"Chris Basement's Installation Video"})}),"\n",(0,s.jsxs)(n.h3,{id:"check-z-endstop-m119",children:["Check Z Endstop ",(0,s.jsx)(n.code,{children:"M119"})]}),"\n",(0,s.jsx)(n.p,{children:"Do not home Z before checking this step, otherwise, the nozzle might crash into the print bed."}),"\n",(0,s.jsx)(n.p,{children:"This is the return message after sending the M119 command (report endstop status)."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"Send: M119\nRecv: x:open y:open z:open\n"})}),"\n",(0,s.jsxs)(n.p,{children:["If z min is not open, check your configuration. ",(0,s.jsx)(n.code,{children:"#define Z_MAX_ENDSTOP_HIT_STATE HIGH"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Ensure Z motor is off/unlocked"}),"\n",(0,s.jsx)(n.li,{children:"Move the Z-axis down by hand until the nozzle touches the bed"}),"\n",(0,s.jsxs)(n.li,{children:["Send ",(0,s.jsx)(n.code,{children:"M102 S-2"}),", the return value should be 0.00mm, then send M119 again, you can see the z endstop is now triggered."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"Send: M119\nRecv: x:open y:open z:TRIGGERED\n"})}),"\n",(0,s.jsx)(n.h3,{id:"check-connection",children:"Check Connection"}),"\n",(0,s.jsxs)(n.p,{children:["Check the connection with ",(0,s.jsx)(n.code,{children:"M102 S-1"}),". Here's an example of the return message, check if the connection and wire order are correct if it returns blank or other strings."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"Send: M102 S-1\nRecv: V1.0 pandapi3d.com\n"})}),"\n",(0,s.jsx)(n.h2,{id:"if-all-the-steps-above-are-correct-you-can-now-home-the-z-axis",children:"If all the steps above are correct, you can now home the Z-axis."})]})}function c(e={}){let{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},82273:function(e,n,i){i.d(n,{Z:function(){return t}});let t=i.p+"assets/images/jxcs_webp-e90fb83e26a5605607e720e487bc6f3a.webp"},79938:function(e,n,i){i.d(n,{Z:function(){return a},a:function(){return r}});var t=i(75271);let s={},o=t.createContext(s);function r(e){let n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);